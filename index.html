<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</head>
<body>
  <script>
    // 1. Сразу говорим Glide, что мы живы
    parent.postMessage({ type: "ready" }, "*");

    window.addEventListener("message", (e) => {
      if (e.data.type === "run") {
        const { code, p1, p2, p3 } = e.data.body.values;
        let result;

        try {
          // 2. Создаем функцию «на лету» из того, что ты напишешь в Glide
          const fn = new Function('p1', 'p2', 'p3', '_', code || 'return "Введите код"');
          result = fn(p1, p2, p3, _);
        } catch (err) {
          result = "Error: " + err.message;
        }

        // 3. Отправляем результат обратно (ЭТО УБЕРЕТ КРУЖОК)
        parent.postMessage({ type: "result", body: result }, "*");
      }
    });
  </script>
</body>
</html>
